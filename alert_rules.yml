groups:
  - name: WeatherServiceAlerts
    rules:
      # 1. High Error Rate (Critical)
      - alert: WeatherApiHighErrorRate
        expr: |
          sum(rate(weather_service_http_requests_total{code=~"5.."}[5m])) 
          / 
          sum(rate(weather_service_http_requests_total[5m])) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High Error Rate on {{ $labels.instance }}"
          description: "Service is returning > 5% errors for more than 2 minutes."

      # 2. Latency Breach (Warning)
      - alert: WeatherApiHighLatency
        expr: histogram_quantile(0.99, sum by (le) (rate(weather_service_http_request_duration_seconds_bucket[5m]))) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "P99 Latency High"
          description: "99th percentile latency is above 500ms for 5 minutes."

      # 3. Cache Performance Degraded (Informational)
      - alert: LowCacheHitRate
        expr: |
          rate(weather_service_cache_hits_total[5m]) 
          / 
          (rate(weather_service_cache_hits_total[5m]) + rate(weather_service_cache_misses_total[5m])) < 0.2
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Cache efficiency is low"
          description: "Hit rate is below 20%, check upstream API usage."